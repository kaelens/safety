{"ast":null,"code":"// An object representing a vulnerability either as the result of an\n// advisory or due to the package in question depending exclusively on\n// vulnerable versions of a dep.\n//\n// - name: package name\n// - range: Set of vulnerable versions\n// - nodes: Set of nodes affected\n// - effects: Set of vulns triggered by this one\n// - advisories: Set of advisories (including metavulns) causing this vuln.\n//   All of the entries in via are vulnerability objects returned by\n//   @npmcli/metavuln-calculator\n// - via: dependency vulns which cause this one\nconst {\n  satisfies,\n  simplifyRange\n} = require('semver');\n\nconst semverOpt = {\n  loose: true,\n  includePrerelease: true\n};\n\nconst npa = require('npm-package-arg');\n\nconst _range = Symbol('_range');\n\nconst _simpleRange = Symbol('_simpleRange');\n\nconst _fixAvailable = Symbol('_fixAvailable');\n\nconst severities = new Map([['info', 0], ['low', 1], ['moderate', 2], ['high', 3], ['critical', 4], [null, -1]]);\n\nfor (const [name, val] of severities.entries()) severities.set(val, name);\n\nclass Vuln {\n  constructor({\n    name,\n    advisory\n  }) {\n    this.name = name;\n    this.via = new Set();\n    this.advisories = new Set();\n    this.severity = null;\n    this.effects = new Set();\n    this.topNodes = new Set();\n    this[_range] = null;\n    this[_simpleRange] = null;\n    this.nodes = new Set(); // assume a fix is available unless it hits a top node\n    // that locks it in place, setting this to false or {isSemVerMajor, version}.\n\n    this[_fixAvailable] = true;\n    this.addAdvisory(advisory);\n    this.packument = advisory.packument;\n    this.versions = advisory.versions;\n  }\n\n  get fixAvailable() {\n    return this[_fixAvailable];\n  }\n\n  set fixAvailable(f) {\n    this[_fixAvailable] = f; // if there's a fix available for this at the top level, it means that\n    // it will also fix the vulns that led to it being there.  to get there,\n    // we set the vias to the most \"strict\" of fix availables.\n    // - false: no fix is available\n    // - {name, version, isSemVerMajor} fix requires -f, is semver major\n    // - {name, version} fix requires -f, not semver major\n    // - true: fix does not require -f\n\n    for (const v of this.via) {\n      // don't blow up on loops\n      if (v.fixAvailable === f) continue;\n      if (f === false) v.fixAvailable = f;else if (v.fixAvailable === true) v.fixAvailable = f;else if (typeof f === 'object' && (typeof v.fixAvailable !== 'object' || !v.fixAvailable.isSemVerMajor)) v.fixAvailable = f;\n    }\n  }\n\n  testSpec(spec) {\n    const specObj = npa(spec);\n    if (!specObj.registry) return true;\n\n    for (const v of this.versions) {\n      if (satisfies(v, spec) && !satisfies(v, this.range, semverOpt)) return false;\n    }\n\n    return true;\n  }\n\n  toJSON() {\n    // sort so that they're always in a consistent order\n    return {\n      name: this.name,\n      severity: this.severity,\n      // just loop over the advisories, since via is only Vuln objects,\n      // and calculated advisories have all the info we need\n      via: [...this.advisories].map(v => v.type === 'metavuln' ? v.dependency : { ...v,\n        versions: undefined,\n        vulnerableVersions: undefined,\n        id: undefined\n      }).sort((a, b) => String(a.source || a).localeCompare(String(b.source || b))),\n      effects: [...this.effects].map(v => v.name).sort(\n      /* istanbul ignore next */\n      (a, b) => a.localeCompare(b)),\n      range: this.simpleRange,\n      nodes: [...this.nodes].map(n => n.location).sort(\n      /* istanbul ignore next */\n      (a, b) => a.localeCompare(b)),\n      fixAvailable: this[_fixAvailable]\n    };\n  }\n\n  addVia(v) {\n    this.via.add(v);\n    v.effects.add(this); // call the setter since we might add vias _after_ setting fixAvailable\n\n    this.fixAvailable = this.fixAvailable;\n  }\n\n  deleteVia(v) {\n    this.via.delete(v);\n    v.effects.delete(this);\n  }\n\n  deleteAdvisory(advisory) {\n    this.advisories.delete(advisory); // make sure we have the max severity of all the vulns causing this one\n\n    this.severity = null;\n    this[_range] = null;\n    this[_simpleRange] = null; // refresh severity\n\n    for (const advisory of this.advisories) this.addAdvisory(advisory); // remove any effects that are no longer relevant\n\n\n    const vias = new Set([...this.advisories].map(a => a.dependency));\n\n    for (const via of this.via) {\n      if (!vias.has(via.name)) this.deleteVia(via);\n    }\n  }\n\n  addAdvisory(advisory) {\n    this.advisories.add(advisory);\n    const sev = severities.get(advisory.severity);\n    this[_range] = null;\n    this[_simpleRange] = null;\n    if (sev > severities.get(this.severity)) this.severity = advisory.severity;\n  }\n\n  get range() {\n    return this[_range] || (this[_range] = [...this.advisories].map(v => v.range).join(' || '));\n  }\n\n  get simpleRange() {\n    if (this[_simpleRange] && this[_simpleRange] === this[_range]) return this[_simpleRange];\n    const versions = [...this.advisories][0].versions;\n    const range = this.range;\n    const simple = simplifyRange(versions, range, semverOpt);\n    return this[_simpleRange] = this[_range] = simple;\n  }\n\n  isVulnerable(node) {\n    if (this.nodes.has(node)) return true;\n    const {\n      version\n    } = node.package;\n    if (!version) return false;\n\n    for (const v of this.advisories) {\n      if (v.testVersion(version)) {\n        this.nodes.add(node);\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n}\n\nmodule.exports = Vuln;","map":{"version":3,"sources":["/Users/kaelen/nsc-mds/node_modules/npm/node_modules/@npmcli/arborist/lib/vuln.js"],"names":["satisfies","simplifyRange","require","semverOpt","loose","includePrerelease","npa","_range","Symbol","_simpleRange","_fixAvailable","severities","Map","name","val","entries","set","Vuln","constructor","advisory","via","Set","advisories","severity","effects","topNodes","nodes","addAdvisory","packument","versions","fixAvailable","f","v","isSemVerMajor","testSpec","spec","specObj","registry","range","toJSON","map","type","dependency","undefined","vulnerableVersions","id","sort","a","b","String","source","localeCompare","simpleRange","n","location","addVia","add","deleteVia","delete","deleteAdvisory","vias","has","sev","get","join","simple","isVulnerable","node","version","package","testVersion","module","exports"],"mappings":"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","sourcesContent":["// An object representing a vulnerability either as the result of an\n// advisory or due to the package in question depending exclusively on\n// vulnerable versions of a dep.\n//\n// - name: package name\n// - range: Set of vulnerable versions\n// - nodes: Set of nodes affected\n// - effects: Set of vulns triggered by this one\n// - advisories: Set of advisories (including metavulns) causing this vuln.\n//   All of the entries in via are vulnerability objects returned by\n//   @npmcli/metavuln-calculator\n// - via: dependency vulns which cause this one\n\nconst {satisfies, simplifyRange} = require('semver')\nconst semverOpt = { loose: true, includePrerelease: true }\n\nconst npa = require('npm-package-arg')\nconst _range = Symbol('_range')\nconst _simpleRange = Symbol('_simpleRange')\nconst _fixAvailable = Symbol('_fixAvailable')\n\nconst severities = new Map([\n  ['info', 0],\n  ['low', 1],\n  ['moderate', 2],\n  ['high', 3],\n  ['critical', 4],\n  [null, -1],\n])\n\nfor (const [name, val] of severities.entries())\n  severities.set(val, name)\n\nclass Vuln {\n  constructor ({ name, advisory }) {\n    this.name = name\n    this.via = new Set()\n    this.advisories = new Set()\n    this.severity = null\n    this.effects = new Set()\n    this.topNodes = new Set()\n    this[_range] = null\n    this[_simpleRange] = null\n    this.nodes = new Set()\n    // assume a fix is available unless it hits a top node\n    // that locks it in place, setting this to false or {isSemVerMajor, version}.\n    this[_fixAvailable] = true\n    this.addAdvisory(advisory)\n    this.packument = advisory.packument\n    this.versions = advisory.versions\n  }\n\n  get fixAvailable () {\n    return this[_fixAvailable]\n  }\n\n  set fixAvailable (f) {\n    this[_fixAvailable] = f\n    // if there's a fix available for this at the top level, it means that\n    // it will also fix the vulns that led to it being there.  to get there,\n    // we set the vias to the most \"strict\" of fix availables.\n    // - false: no fix is available\n    // - {name, version, isSemVerMajor} fix requires -f, is semver major\n    // - {name, version} fix requires -f, not semver major\n    // - true: fix does not require -f\n    for (const v of this.via) {\n      // don't blow up on loops\n      if (v.fixAvailable === f)\n        continue\n\n      if (f === false)\n        v.fixAvailable = f\n      else if (v.fixAvailable === true)\n        v.fixAvailable = f\n      else if (typeof f === 'object' && (\n        typeof v.fixAvailable !== 'object' || !v.fixAvailable.isSemVerMajor))\n        v.fixAvailable = f\n    }\n  }\n\n  testSpec (spec) {\n    const specObj = npa(spec)\n    if (!specObj.registry)\n      return true\n\n    for (const v of this.versions) {\n      if (satisfies(v, spec) && !satisfies(v, this.range, semverOpt))\n        return false\n    }\n    return true\n  }\n\n  toJSON () {\n    // sort so that they're always in a consistent order\n    return {\n      name: this.name,\n      severity: this.severity,\n      // just loop over the advisories, since via is only Vuln objects,\n      // and calculated advisories have all the info we need\n      via: [...this.advisories].map(v => v.type === 'metavuln' ? v.dependency : {\n        ...v,\n        versions: undefined,\n        vulnerableVersions: undefined,\n        id: undefined,\n      }).sort((a, b) =>\n        String(a.source || a).localeCompare(String(b.source || b))),\n      effects: [...this.effects].map(v => v.name)\n        .sort(/* istanbul ignore next */(a, b) => a.localeCompare(b)),\n      range: this.simpleRange,\n      nodes: [...this.nodes].map(n => n.location)\n        .sort(/* istanbul ignore next */(a, b) => a.localeCompare(b)),\n      fixAvailable: this[_fixAvailable],\n    }\n  }\n\n  addVia (v) {\n    this.via.add(v)\n    v.effects.add(this)\n    // call the setter since we might add vias _after_ setting fixAvailable\n    this.fixAvailable = this.fixAvailable\n  }\n\n  deleteVia (v) {\n    this.via.delete(v)\n    v.effects.delete(this)\n  }\n\n  deleteAdvisory (advisory) {\n    this.advisories.delete(advisory)\n    // make sure we have the max severity of all the vulns causing this one\n    this.severity = null\n    this[_range] = null\n    this[_simpleRange] = null\n    // refresh severity\n    for (const advisory of this.advisories)\n      this.addAdvisory(advisory)\n\n    // remove any effects that are no longer relevant\n    const vias = new Set([...this.advisories].map(a => a.dependency))\n    for (const via of this.via) {\n      if (!vias.has(via.name))\n        this.deleteVia(via)\n    }\n  }\n\n  addAdvisory (advisory) {\n    this.advisories.add(advisory)\n    const sev = severities.get(advisory.severity)\n    this[_range] = null\n    this[_simpleRange] = null\n    if (sev > severities.get(this.severity))\n      this.severity = advisory.severity\n  }\n\n  get range () {\n    return this[_range] ||\n      (this[_range] = [...this.advisories].map(v => v.range).join(' || '))\n  }\n\n  get simpleRange () {\n    if (this[_simpleRange] && this[_simpleRange] === this[_range])\n      return this[_simpleRange]\n\n    const versions = [...this.advisories][0].versions\n    const range = this.range\n    const simple = simplifyRange(versions, range, semverOpt)\n    return this[_simpleRange] = this[_range] = simple\n  }\n\n  isVulnerable (node) {\n    if (this.nodes.has(node))\n      return true\n\n    const { version } = node.package\n    if (!version)\n      return false\n\n    for (const v of this.advisories) {\n      if (v.testVersion(version)) {\n        this.nodes.add(node)\n        return true\n      }\n    }\n\n    return false\n  }\n}\n\nmodule.exports = Vuln\n"]},"metadata":{},"sourceType":"script"}