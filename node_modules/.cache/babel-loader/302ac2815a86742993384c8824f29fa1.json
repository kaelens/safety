{"ast":null,"code":"// don't expand so that we only assemble the set of defaults when needed\nconst configDefs = require('./utils/config/index.js');\n\nconst mkdirp = require('mkdirp-infer-owner');\n\nconst {\n  dirname\n} = require('path');\n\nconst {\n  promisify\n} = require('util');\n\nconst fs = require('fs');\n\nconst readFile = promisify(fs.readFile);\nconst writeFile = promisify(fs.writeFile);\n\nconst {\n  spawn\n} = require('child_process');\n\nconst {\n  EOL\n} = require('os');\n\nconst ini = require('ini'); // take an array of `[key, value, k2=v2, k3, v3, ...]` and turn into\n// { key: value, k2: v2, k3: v3 }\n\n\nconst keyValues = args => {\n  const kv = {};\n\n  for (let i = 0; i < args.length; i++) {\n    const arg = args[i].split('=');\n    const key = arg.shift();\n    const val = arg.length ? arg.join('=') : i < args.length - 1 ? args[++i] : '';\n    kv[key.trim()] = val.trim();\n  }\n\n  return kv;\n};\n\nconst publicVar = k => !/^(\\/\\/[^:]+:)?_/.test(k);\n\nconst BaseCommand = require('./base-command.js');\n\nclass Config extends BaseCommand {\n  static get description() {\n    return 'Manage the npm configuration files';\n  }\n  /* istanbul ignore next - see test/lib/load-all-commands.js */\n\n\n  static get name() {\n    return 'config';\n  }\n  /* istanbul ignore next - see test/lib/load-all-commands.js */\n\n\n  static get usage() {\n    return ['set <key>=<value> [<key>=<value> ...]', 'get [<key> [<key> ...]]', 'delete <key> [<key> ...]', 'list [--json]', 'edit'];\n  }\n\n  async completion(opts) {\n    const argv = opts.conf.argv.remain;\n    if (argv[1] !== 'config') argv.unshift('config');\n\n    if (argv.length === 2) {\n      const cmds = ['get', 'set', 'delete', 'ls', 'rm', 'edit'];\n      if (opts.partialWord !== 'l') cmds.push('list');\n      return cmds;\n    }\n\n    const action = argv[2];\n\n    switch (action) {\n      case 'set':\n        // todo: complete with valid values, if possible.\n        if (argv.length > 3) return [];\n      // fallthrough\n\n      /* eslint no-fallthrough:0 */\n\n      case 'get':\n      case 'delete':\n      case 'rm':\n        return Object.keys(configDefs.definitions);\n\n      case 'edit':\n      case 'list':\n      case 'ls':\n      default:\n        return [];\n    }\n  }\n\n  exec(args, cb) {\n    this.config(args).then(() => cb()).catch(cb);\n  }\n\n  execWorkspaces(args, filters, cb) {\n    this.npm.log.warn('config', 'This command does not support workspaces.');\n    this.exec(args, cb);\n  }\n\n  async config([action, ...args]) {\n    this.npm.log.disableProgress();\n\n    try {\n      switch (action) {\n        case 'set':\n          await this.set(args);\n          break;\n\n        case 'get':\n          await this.get(args);\n          break;\n\n        case 'delete':\n        case 'rm':\n        case 'del':\n          await this.del(args);\n          break;\n\n        case 'list':\n        case 'ls':\n          await (this.npm.config.get('json') ? this.listJson() : this.list());\n          break;\n\n        case 'edit':\n          await this.edit();\n          break;\n\n        default:\n          throw this.usageError();\n      }\n    } finally {\n      this.npm.log.enableProgress();\n    }\n  }\n\n  async set(args) {\n    if (!args.length) throw this.usageError();\n    const where = this.npm.config.get('global') ? 'global' : 'user';\n\n    for (const [key, val] of Object.entries(keyValues(args))) {\n      this.npm.log.info('config', 'set %j %j', key, val);\n      this.npm.config.set(key, val || '', where);\n      if (!this.npm.config.validate(where)) this.npm.log.warn('config', 'omitting invalid config values');\n    }\n\n    await this.npm.config.save(where);\n  }\n\n  async get(keys) {\n    if (!keys.length) return this.list();\n    const out = [];\n\n    for (const key of keys) {\n      if (!publicVar(key)) throw `The ${key} option is protected, and cannot be retrieved in this way`;\n      const pref = keys.length > 1 ? `${key}=` : '';\n      out.push(pref + this.npm.config.get(key));\n    }\n\n    this.npm.output(out.join('\\n'));\n  }\n\n  async del(keys) {\n    if (!keys.length) throw this.usageError();\n    const where = this.npm.config.get('global') ? 'global' : 'user';\n\n    for (const key of keys) this.npm.config.delete(key, where);\n\n    await this.npm.config.save(where);\n  }\n\n  async edit() {\n    const global = this.npm.config.get('global');\n    const e = this.npm.config.get('editor');\n    const where = global ? 'global' : 'user';\n    const file = this.npm.config.data.get(where).source; // save first, just to make sure it's synced up\n    // this also removes all the comments from the last time we edited it.\n\n    await this.npm.config.save(where);\n    const data = (await readFile(file, 'utf8').catch(() => '')).replace(/\\r\\n/g, '\\n');\n    const entries = Object.entries(configDefs.defaults);\n    const defData = entries.reduce((str, [key, val]) => {\n      const obj = {\n        [key]: val\n      };\n      const i = ini.stringify(obj).replace(/\\r\\n/g, '\\n') // normalizes output from ini.stringify\n      .replace(/\\n$/m, '').replace(/^/g, '; ').replace(/\\n/g, '\\n; ').split('\\n');\n      return str + '\\n' + i;\n    }, '');\n    const tmpData = `;;;;\n; npm ${where}config file: ${file}\n; this is a simple ini-formatted file\n; lines that start with semi-colons are comments\n; run \\`npm help 7 config\\` for documentation of the various options\n;\n; Configs like \\`@scope:registry\\` map a scope to a given registry url.\n;\n; Configs like \\`//<hostname>/:_authToken\\` are auth that is restricted\n; to the registry host specified.\n\n${data.split('\\n').sort((a, b) => a.localeCompare(b)).join('\\n').trim()}\n\n;;;;\n; all available options shown below with default values\n;;;;\n\n${defData}\n`.split('\\n').join(EOL);\n    await mkdirp(dirname(file));\n    await writeFile(file, tmpData, 'utf8');\n    await new Promise((resolve, reject) => {\n      const [bin, ...args] = e.split(/\\s+/);\n      const editor = spawn(bin, [...args, file], {\n        stdio: 'inherit'\n      });\n      editor.on('exit', code => {\n        if (code) return reject(new Error(`editor process exited with code: ${code}`));\n        return resolve();\n      });\n    });\n  }\n\n  async list() {\n    const msg = [];\n    const long = this.npm.config.get('long');\n\n    for (const [where, {\n      data,\n      source\n    }] of this.npm.config.data.entries()) {\n      if (where === 'default' && !long) continue;\n      const keys = Object.keys(data).sort((a, b) => a.localeCompare(b));\n      if (!keys.length) continue;\n      msg.push(`; \"${where}\" config from ${source}`, '');\n\n      for (const k of keys) {\n        const v = publicVar(k) ? JSON.stringify(data[k]) : '(protected)';\n        const src = this.npm.config.find(k);\n        const overridden = src !== where;\n        msg.push((overridden ? '; ' : '') + `${k} = ${v} ${overridden ? `; overridden by ${src}` : ''}`);\n      }\n\n      msg.push('');\n    }\n\n    if (!long) {\n      msg.push(`; node bin location = ${process.execPath}`, `; cwd = ${process.cwd()}`, `; HOME = ${process.env.HOME}`, '; Run `npm config ls -l` to show all defaults.');\n    }\n\n    this.npm.output(msg.join('\\n').trim());\n  }\n\n  async listJson() {\n    const publicConf = {};\n\n    for (const key in this.npm.config.list[0]) {\n      if (!publicVar(key)) continue;\n      publicConf[key] = this.npm.config.get(key);\n    }\n\n    this.npm.output(JSON.stringify(publicConf, null, 2));\n  }\n\n}\n\nmodule.exports = Config;","map":{"version":3,"sources":["/Users/kaelen/nsc-mds/node_modules/npm/lib/config.js"],"names":["configDefs","require","mkdirp","dirname","promisify","fs","readFile","writeFile","spawn","EOL","ini","keyValues","args","kv","i","length","arg","split","key","shift","val","join","trim","publicVar","k","test","BaseCommand","Config","description","name","usage","completion","opts","argv","conf","remain","unshift","cmds","partialWord","push","action","Object","keys","definitions","exec","cb","config","then","catch","execWorkspaces","filters","npm","log","warn","disableProgress","set","get","del","listJson","list","edit","usageError","enableProgress","where","entries","info","validate","save","out","pref","output","delete","global","e","file","data","source","replace","defaults","defData","reduce","str","obj","stringify","tmpData","sort","a","b","localeCompare","Promise","resolve","reject","bin","editor","stdio","on","code","Error","msg","long","v","JSON","src","find","overridden","process","execPath","cwd","env","HOME","publicConf","module","exports"],"mappings":"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","sourcesContent":["// don't expand so that we only assemble the set of defaults when needed\nconst configDefs = require('./utils/config/index.js')\n\nconst mkdirp = require('mkdirp-infer-owner')\nconst { dirname } = require('path')\nconst { promisify } = require('util')\nconst fs = require('fs')\nconst readFile = promisify(fs.readFile)\nconst writeFile = promisify(fs.writeFile)\nconst { spawn } = require('child_process')\nconst { EOL } = require('os')\nconst ini = require('ini')\n\n// take an array of `[key, value, k2=v2, k3, v3, ...]` and turn into\n// { key: value, k2: v2, k3: v3 }\nconst keyValues = args => {\n  const kv = {}\n  for (let i = 0; i < args.length; i++) {\n    const arg = args[i].split('=')\n    const key = arg.shift()\n    const val = arg.length ? arg.join('=')\n      : i < args.length - 1 ? args[++i]\n      : ''\n    kv[key.trim()] = val.trim()\n  }\n  return kv\n}\n\nconst publicVar = k => !/^(\\/\\/[^:]+:)?_/.test(k)\n\nconst BaseCommand = require('./base-command.js')\nclass Config extends BaseCommand {\n  static get description () {\n    return 'Manage the npm configuration files'\n  }\n\n  /* istanbul ignore next - see test/lib/load-all-commands.js */\n  static get name () {\n    return 'config'\n  }\n\n  /* istanbul ignore next - see test/lib/load-all-commands.js */\n  static get usage () {\n    return [\n      'set <key>=<value> [<key>=<value> ...]',\n      'get [<key> [<key> ...]]',\n      'delete <key> [<key> ...]',\n      'list [--json]',\n      'edit',\n    ]\n  }\n\n  async completion (opts) {\n    const argv = opts.conf.argv.remain\n    if (argv[1] !== 'config')\n      argv.unshift('config')\n\n    if (argv.length === 2) {\n      const cmds = ['get', 'set', 'delete', 'ls', 'rm', 'edit']\n      if (opts.partialWord !== 'l')\n        cmds.push('list')\n\n      return cmds\n    }\n\n    const action = argv[2]\n    switch (action) {\n      case 'set':\n        // todo: complete with valid values, if possible.\n        if (argv.length > 3)\n          return []\n\n        // fallthrough\n        /* eslint no-fallthrough:0 */\n      case 'get':\n      case 'delete':\n      case 'rm':\n        return Object.keys(configDefs.definitions)\n      case 'edit':\n      case 'list':\n      case 'ls':\n      default:\n        return []\n    }\n  }\n\n  exec (args, cb) {\n    this.config(args).then(() => cb()).catch(cb)\n  }\n\n  execWorkspaces (args, filters, cb) {\n    this.npm.log.warn('config', 'This command does not support workspaces.')\n    this.exec(args, cb)\n  }\n\n  async config ([action, ...args]) {\n    this.npm.log.disableProgress()\n    try {\n      switch (action) {\n        case 'set':\n          await this.set(args)\n          break\n        case 'get':\n          await this.get(args)\n          break\n        case 'delete':\n        case 'rm':\n        case 'del':\n          await this.del(args)\n          break\n        case 'list':\n        case 'ls':\n          await (this.npm.config.get('json') ? this.listJson() : this.list())\n          break\n        case 'edit':\n          await this.edit()\n          break\n        default:\n          throw this.usageError()\n      }\n    } finally {\n      this.npm.log.enableProgress()\n    }\n  }\n\n  async set (args) {\n    if (!args.length)\n      throw this.usageError()\n\n    const where = this.npm.config.get('global') ? 'global' : 'user'\n    for (const [key, val] of Object.entries(keyValues(args))) {\n      this.npm.log.info('config', 'set %j %j', key, val)\n      this.npm.config.set(key, val || '', where)\n      if (!this.npm.config.validate(where))\n        this.npm.log.warn('config', 'omitting invalid config values')\n    }\n\n    await this.npm.config.save(where)\n  }\n\n  async get (keys) {\n    if (!keys.length)\n      return this.list()\n\n    const out = []\n    for (const key of keys) {\n      if (!publicVar(key))\n        throw `The ${key} option is protected, and cannot be retrieved in this way`\n\n      const pref = keys.length > 1 ? `${key}=` : ''\n      out.push(pref + this.npm.config.get(key))\n    }\n    this.npm.output(out.join('\\n'))\n  }\n\n  async del (keys) {\n    if (!keys.length)\n      throw this.usageError()\n\n    const where = this.npm.config.get('global') ? 'global' : 'user'\n    for (const key of keys)\n      this.npm.config.delete(key, where)\n    await this.npm.config.save(where)\n  }\n\n  async edit () {\n    const global = this.npm.config.get('global')\n    const e = this.npm.config.get('editor')\n    const where = global ? 'global' : 'user'\n    const file = this.npm.config.data.get(where).source\n\n    // save first, just to make sure it's synced up\n    // this also removes all the comments from the last time we edited it.\n    await this.npm.config.save(where)\n\n    const data = (\n      await readFile(file, 'utf8').catch(() => '')\n    ).replace(/\\r\\n/g, '\\n')\n    const entries = Object.entries(configDefs.defaults)\n    const defData = entries.reduce((str, [key, val]) => {\n      const obj = { [key]: val }\n      const i = ini.stringify(obj)\n        .replace(/\\r\\n/g, '\\n') // normalizes output from ini.stringify\n        .replace(/\\n$/m, '')\n        .replace(/^/g, '; ')\n        .replace(/\\n/g, '\\n; ')\n        .split('\\n')\n      return str + '\\n' + i\n    }, '')\n\n    const tmpData = `;;;;\n; npm ${where}config file: ${file}\n; this is a simple ini-formatted file\n; lines that start with semi-colons are comments\n; run \\`npm help 7 config\\` for documentation of the various options\n;\n; Configs like \\`@scope:registry\\` map a scope to a given registry url.\n;\n; Configs like \\`//<hostname>/:_authToken\\` are auth that is restricted\n; to the registry host specified.\n\n${data.split('\\n').sort((a, b) => a.localeCompare(b)).join('\\n').trim()}\n\n;;;;\n; all available options shown below with default values\n;;;;\n\n${defData}\n`.split('\\n').join(EOL)\n    await mkdirp(dirname(file))\n    await writeFile(file, tmpData, 'utf8')\n    await new Promise((resolve, reject) => {\n      const [bin, ...args] = e.split(/\\s+/)\n      const editor = spawn(bin, [...args, file], { stdio: 'inherit' })\n      editor.on('exit', (code) => {\n        if (code)\n          return reject(new Error(`editor process exited with code: ${code}`))\n        return resolve()\n      })\n    })\n  }\n\n  async list () {\n    const msg = []\n    const long = this.npm.config.get('long')\n    for (const [where, { data, source }] of this.npm.config.data.entries()) {\n      if (where === 'default' && !long)\n        continue\n\n      const keys = Object.keys(data).sort((a, b) => a.localeCompare(b))\n      if (!keys.length)\n        continue\n\n      msg.push(`; \"${where}\" config from ${source}`, '')\n      for (const k of keys) {\n        const v = publicVar(k) ? JSON.stringify(data[k]) : '(protected)'\n        const src = this.npm.config.find(k)\n        const overridden = src !== where\n        msg.push((overridden ? '; ' : '') +\n          `${k} = ${v} ${overridden ? `; overridden by ${src}` : ''}`)\n      }\n      msg.push('')\n    }\n\n    if (!long) {\n      msg.push(\n        `; node bin location = ${process.execPath}`,\n        `; cwd = ${process.cwd()}`,\n        `; HOME = ${process.env.HOME}`,\n        '; Run `npm config ls -l` to show all defaults.'\n      )\n    }\n\n    this.npm.output(msg.join('\\n').trim())\n  }\n\n  async listJson () {\n    const publicConf = {}\n    for (const key in this.npm.config.list[0]) {\n      if (!publicVar(key))\n        continue\n\n      publicConf[key] = this.npm.config.get(key)\n    }\n    this.npm.output(JSON.stringify(publicConf, null, 2))\n  }\n}\n\nmodule.exports = Config\n"]},"metadata":{},"sourceType":"script"}